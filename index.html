<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>악성민원 대응 교육 게임</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        // API 엔드포인트 - 배포 후 여기를 Vercel URL로 변경
        const API_URL = '/api/chat';

        const SCENARIOS = [
            {
                title: "폭언 및 욕설",
                initial: "민원인이 전화를 받자마자 큰 소리로 욕설을 합니다.\n\n민원인: \"야! 이게 뭐하는 짓이야! 너희 기관은 일을 이따위로 해? XXX들아! 담당자 바꿔!\"",
                context: "업무 처리 지연에 대한 불만."
            },
            {
                title: "반복적 동일 민원",
                initial: "같은 내용으로 이미 두 번 설명했던 민원인이 또 전화했습니다.\n\n민원인: \"저번에도 말했는데 왜 안 되는 거예요? 이해가 안 가요!\"",
                context: "현행 규정상 불가능한 요청."
            },
            {
                title: "협박 및 권위 과시",
                initial: "민원인이 협박성 발언을 합니다.\n\n민원인: \"내가 누군지 알아? 국회의원, 기자들 다 알아. 당신 이름이 뭐예요?\"",
                context: "정당한 규정을 협박으로 번복시키려는 시도."
            },
            {
                title: "개인정보 무단 요구",
                initial: "민원인이 다른 사람의 개인정보를 요구합니다.\n\n민원인: \"그 사람이 언제 민원 넣었는지 알려주세요!\"",
                context: "개인정보보호법상 불가능."
            },
            {
                title: "장시간 통화",
                initial: "민원인이 30분째 같은 이야기를 반복합니다.\n\n민원인: \"처음부터 다시 설명할게요...\"",
                context: "동일 내용 반복으로 업무 방해."
            }
        ];

        const GUIDELINES = [
            { title: "기본 원칙", items: ["침착하고 차분한 태도", "경청하며 공감", "감정적 대응 금지", "규정에 따른 안내"] },
            { title: "금지 사항", items: ["맞대응", "개인 의견 표현", "불가능한 약속", "타인 정보 공개"] },
            { title: "단계별 대응", items: ["1단계: 경청과 공감", "2단계: 규정 안내", "3단계: 상급자 연결", "4단계: 법적 대응"] }
        ];

        const App = () => {
            const [stage, setStage] = useState('start');
            const [currentScenario, setCurrentScenario] = useState(0);
            const [turn, setTurn] = useState(0);
            const [score, setScore] = useState(0);
            const [input, setInput] = useState('');
            const [conversation, setConversation] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showAdvice, setShowAdvice] = useState(false);
            const [advice, setAdvice] = useState('');
            const [results, setResults] = useState([]);

            const scenario = SCENARIOS[currentScenario];

            const callAPI = async (prompt, type) => {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, type })
                    });
                    
                    if (!response.ok) throw new Error('API 호출 실패');
                    const data = await response.json();
                    return data.response;
                } catch (error) {
                    console.error('API 오류:', error);
                    return type === 'advice' 
                        ? '조언을 불러올 수 없습니다.' 
                        : '민원인 반응을 생성할 수 없습니다.';
                }
            };

            const askSupervisor = async () => {
                setShowAdvice(true);
                setLoading(true);

                const conversationHistory = conversation.map((c, i) => 
                    `${i % 2 === 0 ? '직원' : '민원인'}: ${c.text}`
                ).join('\n');

                const prompt = `당신은 공공기관의 경험 많은 상사입니다.

**상황**: ${scenario.title}
**배경**: ${scenario.context}
**초기**: ${scenario.initial}
**대화**:
${conversationHistory}

신입 직원에게 200자 내외로 간단명료한 조언을 해주세요:
1. 현재 대응의 적절성
2. 다음 주의할 점
3. 활용 가능한 규정

친절하고 실용적인 톤으로 작성해주세요.`;

                const response = await callAPI(prompt, 'advice');
                setAdvice(response);
                setLoading(false);
            };

            const handleSubmit = async () => {
                if (!input.trim()) return;
                
                const newConv = [...conversation, { type: 'user', text: input }];
                setConversation(newConv);
                setInput('');
                setLoading(true);

                const conversationHistory = newConv.map((c, i) => 
                    `${i % 2 === 0 ? '직원' : '민원인'}: ${c.text}`
                ).join('\n');

                const isLastTurn = turn >= 2;

                const prompt = isLastTurn 
                    ? `당신은 공공기관 악성민원 대응 전문가입니다.

**시나리오**: ${scenario.title}
**배경**: ${scenario.context}
**초기**: ${scenario.initial}
**대화**:
${conversationHistory}

마지막 턴입니다. 다음 형식으로 응답하세요:

[민원인 반응]
(2-3문장)

[평가]
- 전체 대응 평가
- 잘한 점과 개선점
- 점수 (0-33점)

[점수]
XX/33점`
                    : `당신은 악성민원인입니다.

**상황**: ${scenario.title}
**배경**: ${scenario.context}
**초기**: ${scenario.initial}
**대화**:
${conversationHistory}

직원의 대응에 대한 현실적인 악성민원인의 반응을 2-3문장으로 작성하세요.
쉽게 만족하지 않고 계속 문제를 제기하거나 새로운 요구를 할 수 있습니다.`;

                const response = await callAPI(prompt, isLastTurn ? 'evaluate' : 'response');

                if (isLastTurn) {
                    const scoreMatch = response.match(/(\d+)\/33점/);
                    const earnedScore = scoreMatch ? parseInt(scoreMatch[1]) : 20;
                    setScore(score + earnedScore);
                    setResults([...results, { title: scenario.title, score: earnedScore }]);
                    setConversation([...newConv, { type: 'system', text: response }]);
                    setStage('feedback');
                } else {
                    const cleanResponse = response.replace('[민원인 반응]', '').trim();
                    setConversation([...newConv, { type: 'system', text: cleanResponse }]);
                    setTurn(turn + 1);
                }

                setLoading(false);
            };

            const nextScenario = () => {
                if (currentScenario < SCENARIOS.length - 1) {
                    setCurrentScenario(currentScenario + 1);
                    setTurn(0);
                    setConversation([]);
                    setStage('scenario');
                } else {
                    setStage('result');
                }
            };

            const restart = () => {
                setStage('start');
                setCurrentScenario(0);
                setTurn(0);
                setScore(0);
                setConversation([]);
                setResults([]);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        {stage === 'start' && (
                            <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                <h1 className="text-4xl font-bold text-gray-800 mb-4">악성민원 대응 교육</h1>
                                <p className="text-gray-600 mb-6">AI 기반 실전 시뮬레이션</p>
                                <div className="bg-indigo-50 rounded-lg p-6 mb-6 text-left">
                                    <h3 className="font-bold text-indigo-900 mb-3">게임 소개</h3>
                                    <ul className="space-y-2 text-gray-700 text-sm">
                                        <li>• 5가지 실제 악성민원 상황</li>
                                        <li>• 각 상황당 3회 대화</li>
                                        <li>• AI 민원인과 실시간 대화</li>
                                        <li>• AI 상사 조언 기능</li>
                                        <li>• 총 165점 만점</li>
                                    </ul>
                                </div>
                                <button onClick={() => setStage('guide')} className="bg-indigo-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-indigo-700">시작하기</button>
                            </div>
                        )}

                        {stage === 'guide' && (
                            <div className="bg-white rounded-2xl shadow-2xl p-8">
                                <h2 className="text-3xl font-bold text-gray-800 mb-6">대응 가이드</h2>
                                {GUIDELINES.map((g, i) => (
                                    <div key={i} className="bg-gray-50 rounded-lg p-6 mb-4">
                                        <h3 className="text-xl font-bold text-indigo-900 mb-3">{g.title}</h3>
                                        <ul className="space-y-2 text-gray-700">
                                            {g.items.map((item, j) => <li key={j}>• {item}</li>)}
                                        </ul>
                                    </div>
                                ))}
                                <button onClick={() => setStage('scenario')} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">실전 시작</button>
                            </div>
                        )}

                        {stage === 'scenario' && (
                            <div className="bg-white rounded-2xl shadow-2xl p-8">
                                <div className="mb-4">
                                    <div className="flex justify-between text-sm font-semibold mb-2">
                                        <span className="text-indigo-600">상황 {currentScenario + 1}/5 | 턴 {turn + 1}/3</span>
                                        <span className="text-gray-600">점수: {score}/165</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                        <div className="bg-indigo-600 h-2 rounded-full" style={{ width: `${((currentScenario * 3 + turn) / 15) * 100}%` }} />
                                    </div>
                                </div>
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">{scenario.title}</h3>
                                <div className="space-y-3 mb-4 max-h-96 overflow-y-auto">
                                    {conversation.length === 0 && (
                                        <div className="bg-red-50 border-l-4 border-red-500 p-4">
                                            <p className="font-bold text-red-900 mb-1">민원인</p>
                                            <p className="text-gray-800 whitespace-pre-line">{scenario.initial}</p>
                                        </div>
                                    )}
                                    {conversation.map((c, i) => (
                                        <div key={i} className={`border-l-4 p-4 ${c.type === 'user' ? 'bg-blue-50 border-blue-500' : 'bg-red-50 border-red-500'}`}>
                                            <p className="font-bold mb-1">{c.type === 'user' ? '직원 (나)' : '민원인'}</p>
                                            <p className="text-gray-800 whitespace-pre-line">{c.text}</p>
                                        </div>
                                    ))}
                                </div>

                                {!loading && (
                                    <>
                                        <button onClick={askSupervisor} className="mb-3 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-semibold hover:bg-purple-200">상사에게 문의</button>
                                        <textarea value={input} onChange={(e) => setInput(e.target.value)} placeholder="민원인에게 어떻게 응답하시겠습니까?" className="w-full p-4 border-2 rounded-lg mb-3" rows="4" />
                                        <button onClick={handleSubmit} disabled={!input.trim()} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 disabled:bg-gray-400">응답 전송</button>
                                    </>
                                )}

                                {loading && (
                                    <div className="flex items-center justify-center py-8">
                                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                                        <span className="ml-3 text-gray-600">AI 응답 생성 중...</span>
                                    </div>
                                )}

                                {showAdvice && (
                                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                        <div className="bg-white rounded-2xl p-6 max-w-2xl w-full">
                                            <h3 className="text-2xl font-bold mb-4">상사의 조언</h3>
                                            {loading ? (
                                                <div className="flex justify-center py-8">
                                                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                                                </div>
                                            ) : (
                                                <div className="bg-purple-50 rounded-lg p-6 mb-4">
                                                    <p className="text-gray-800 whitespace-pre-line">{advice}</p>
                                                </div>
                                            )}
                                            <button onClick={() => setShowAdvice(false)} disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 disabled:bg-gray-400">확인</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {stage === 'feedback' && (
                            <div className="bg-white rounded-2xl shadow-2xl p-8">
                                <h3 className="text-2xl font-bold text-indigo-600 mb-2 text-center">상황 {currentScenario + 1} 완료</h3>
                                <p className="text-center text-3xl font-bold text-indigo-900 mb-6">{results[results.length - 1]?.score}/33점</p>
                                <div className="bg-indigo-50 rounded-lg p-6 mb-6">
                                    <h4 className="font-bold text-indigo-900 mb-3">AI 전문가 평가</h4>
                                    <p className="text-gray-700 whitespace-pre-line">{conversation[conversation.length - 1]?.text}</p>
                                </div>
                                <button onClick={nextScenario} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">
                                    {currentScenario < SCENARIOS.length - 1 ? '다음 상황' : '결과 보기'}
                                </button>
                            </div>
                        )}

                        {stage === 'result' && (
                            <div className="bg-white rounded-2xl shadow-2xl p-8">
                                <h2 className="text-3xl font-bold text-center mb-4">교육 완료!</h2>
                                <div className="text-6xl font-bold text-indigo-600 text-center mb-2">{score}<span className="text-3xl text-gray-500">/165점</span></div>
                                <p className="text-center text-gray-600 mb-6">{score >= 140 ? '최우수' : score >= 115 ? '우수' : score >= 100 ? '양호' : '노력 필요'}</p>
                                <div className="bg-gray-50 rounded-lg p-6 mb-6">
                                    <h3 className="font-bold mb-4">상황별 결과</h3>
                                    {results.map((r, i) => (
                                        <div key={i} className="flex justify-between p-3 bg-white rounded mb-2">
                                            <span>{i + 1}. {r.title}</span>
                                            <span className="font-bold text-indigo-600">{r.score}/33점</span>
                                        </div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={restart} className="bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">다시 도전</button>
                                    <button onClick={() => setStage('guide')} className="bg-gray-600 text-white py-3 rounded-lg font-bold hover:bg-gray-700">가이드 보기</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>